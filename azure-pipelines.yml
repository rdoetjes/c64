# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

variables:
  - group: c64

pool:
  name: Pi4

jobs:
- job: CI
  steps:
    - script: | 
        set -e
        echo "create artefact dir"
        mkdir $(Pipeline.Workspace)/s/c64

        for d in */; do
          prg=$(echo "$d"|sed -s 's/\///g')

          if [ -f $(Pipeline.Workspace)/s/$d/main.asm ]; then
            echo "Building $prg"
            java -jar /usr/local/bin/KickAss.jar $(Pipeline.Workspace)/s/$d/main.asm -odir $(Pipeline.Workspace)/s/$d/build -o $(Pipeline.Workspace)/s/$d/build/$prg.prg
          
            echo "Copying $prg"
            cp $(Pipeline.Workspace)/s/$d/build/$prg.prg $(Pipeline.Workspace)/s/c64
          fi
        done
      displayName: 'Assemble Code'

    - task: PublishPipelineArtifact@1
      inputs:
        path: '$(Pipeline.Workspace)/s/c64'
        artifactName: c64
        artifactType: 'pipeline' 

- job: CD
  dependsOn: CI
  steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        source: 'current' 
        path: '$(Pipeline.Workspace)' 

    - script: lftp -u "$(ftpusername)","$(ftppassword)" -e "lcd $(Pipeline.Workspace)/c64;cd /Usb0;cd Dev;mput *.prg;quit" $(ftphost)
      displayName: "Upload all PRGs to Ultimate II"
